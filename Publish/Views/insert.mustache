<html>
<head>
<script>
function submitForm(oFormElement){
  var params = { 
        {{#properties}} 
        {{name}}:  document.querySelector('#id_{{name}}').value,
        {{/properties}}
    };
    {{#references}}
    if({{isManyToMany}}){
        var checkboxes = []
        var list = document.querySelectorAll( ' .{{model}}_checkbox ' );
        for (var item of list) {
            if(item.checked){
                checkboxes.push(item.value)
            } 
        }
        params['{{model}}_id']= checkboxes;

    }else{
        var e = document.getElementById("select_{{model}}");
        var result = e.options[e.selectedIndex].value;
        params['{{model}}_id']= result;
    }
    console.log(JSON.stringify(params))
    {{/references}}
  
    var xhr = new XMLHttpRequest();
    xhr.open (oFormElement.method, oFormElement.action, false);
    xhr.setRequestHeader( "Content-Type", "application/json" );
    xhr.send (JSON.stringify(params));
}


{{#hasReferences}}
    function loadValues(model, label, controlId, isManyToMany){
        let route = '/api/'+model;
        var xhr = new XMLHttpRequest();
        xhr.open("GET", route, true);
        xhr.onreadystatechange = function () {
            if(xhr.readyState === 4 && xhr.status === 200) {
                var control = document.getElementById(controlId);
                var data = JSON.parse(this.responseText);

                if(isManyToMany){
                   if(data.constructor === Array){ 
                        data.map(row => {
                                var checkbox = document.createElement("input");
                                checkbox.type = "checkbox"; 
                                checkbox.class = "{{model}}_checkbox";
                                checkbox.value = row['id'];
                                checkbox.id = "checkbox_"+ row['id']; 
                                var l = document.createElement('label');                 
                                l.htmlFor ="checkbox_"+ row['id'];                             
                                l.appendChild(document.createTextNode(row[label])); 
                                control.appendChild(checkbox); 
                                control.appendChild(l); 
                           
                        });
                    }
                }else{ 
                    var select = document.createElement("select");
                    select.id = 'select_'+model ;
                    data.forEach(row => {
                        var option = document.createElement("option");
                        option.text = row[label];
                        option.value = row['id'];
                        select.add(option);
                    });
                    control.appendChild(select);
                }
            }
        }
        xhr.send();
    }
    window.onload = function() {
        {{#references}}
        loadValues('{{model}}','{{label}}','div{{model}}value', {{isManyToMany}});
        {{/references}}
    }
 {{/hasReferences}}


</script>
</head>
    <body>
     {{>menu}}

    <form method="post" action="/api/{{title}}" onsubmit="return submitForm(this);">
        Insert {{title}}
    {{#properties}}
        <div>
        <label>{{name}} {{^required}} * {{/required}}:</label>
                <input   id="id_{{name}}" name="{{name}}" {{#restrictions}} {{restriction}}='{{val}}' {{/restrictions}} {{^required}} required {{/required}} />
        </div>
    {{/properties}}
    {{#references}}
        <label>{{model}}:</label>
        <div id="div{{model}}value"></div>
    {{/references}}

    <input type="submit" value="Save"/>
    </form>
 </body>

</html>